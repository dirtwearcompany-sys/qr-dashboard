<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Redirect</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  text-align:center;
}
.container {
  background:white;
  padding:30px;
  border-radius:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
  max-width:400px;
}
h1 { color:#4CAF50; }
</style>
</head>

<body>
<div class="container">
  <h1>Redirectingâ€¦</h1>
  <p id="status">Please wait</p>
</div>

<script>
// ---------------- FIREBASE ----------------
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e",
  storageBucket: "qr-tracker-4b53e.appspot.com",
  messagingSenderId: "329754045002",
  appId: "1:329754045002:web:922633ad6ada8018a1d4b3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- GET QR ID ----------------
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

if (!id) {
  document.getElementById("status").textContent = "Invalid QR Code";
  throw new Error("No QR ID");
}

// ---------------- LOOKUP QR ----------------
const qrRef = db.collection("qrcodes").doc(id);

qrRef.get().then(doc => {
  if (!doc.exists) {
    document.getElementById("status").textContent = "QR Code not found";
    return;
  }

  const data = doc.data();
  const destination = data.text;

  if (!destination) {
    document.getElementById("status").textContent = "No destination URL";
    return;
  }

  const now = new Date();

  // ---------------- LOG SCAN ----------------
  qrRef.collection("scans").add({
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    readable: now.toLocaleString()
  });

  // ---------------- UPDATE COUNTERS ----------------
  qrRef.update({
    scans: firebase.firestore.FieldValue.increment(1),
    lastScan: firebase.firestore.FieldValue.serverTimestamp()
  });

  // ---------------- REDIRECT ----------------
  setTimeout(() => {
    window.location.href = destination;
  }, 1500);

}).catch(err => {
  document.getElementById("status").textContent = "Error loading QR";
  console.error(err);
});
</script>
</body>
</html>
