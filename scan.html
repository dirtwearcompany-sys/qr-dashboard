<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Scan</title>
<style>
body { font-family: Arial, sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; text-align:center; background:#f4f4f4; }
.container { background:white; padding:30px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); max-width:400px; }
h1 { color:#4CAF50; }
p { font-size:18px; }
a { color:#2196F3; text-decoration:none; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
<h1>Redirecting...</h1>
<p id="message">Please wait while we record your scan.</p>
<p id="countdown"></p>
<p id="fallback" style="display:none;">If not redirected, <a id="redirectLink" href="#">click here</a>.</p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ---------------------- FIREBASE CONFIG ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e",
  storageBucket: "qr-tracker-4b53e.appspot.com",
  messagingSenderId: "329754045002",
  appId: "1:329754045002:web:922633ad6ada8018a1d4b3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------------- GET QR ID ----------------------
const params = new URLSearchParams(window.location.search);
const id = params.get('id');

if (!id) {
  document.getElementById('message').textContent = "Invalid QR Code.";
} else {
  const docRef = db.collection('qrcodes').doc(id);
  const now = firebase.firestore.Timestamp.now();

  // ---------------------- INCREMENT SCANS + UPDATE lastScan ----------------------
  docRef.update({
    scans: firebase.firestore.FieldValue.increment(1),
    lastScan: now
  })
  .then(() => console.log("Scan recorded âœ…"))
  .catch(err => console.error("Failed to record scan:", err));

  // ---------------------- GET DOCUMENT AND REDIRECT ----------------------
  docRef.get().then(doc => {
    if (!doc.exists) {
      document.getElementById('message').textContent = "QR Code not found.";
      return;
    }

    const redirectUrl = doc.data().text || "#";

    // Countdown redirect
    let countdown = 3;
    const countdownElem = document.getElementById('countdown');
    const interval = setInterval(() => {
      countdownElem.textContent = `Redirecting in ${countdown}...`;
      countdown--;
      if (countdown < 0) {
        clearInterval(interval);
        window.location.href = redirectUrl;
      }
    }, 1000);

    // Fallback link
    const fallbackLink = document.getElementById('redirectLink');
    fallbackLink.href = redirectUrl;
    document.getElementById('fallback').style.display = 'block';
  }).catch(err => {
    console.error(err);
    document.getElementById('message').textContent = "An error occurred.";
  });
}
</script>
</body>
</html>
