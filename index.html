<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>QR Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
body { font-family: Arial; max-width: 900px; margin:auto; padding:20px }
input, button { padding:8px; margin:5px; width:300px }
.qr-item { display:flex; border:1px solid #ccc; padding:10px; margin-bottom:10px }
.qr-info { margin-left:20px }
button { cursor:pointer }
.delete { background:red; color:white; border:none }
.download { background:green; color:white; border:none; margin-left:5px }
</style>
</head>

<body>
<h1>QR Dashboard</h1>

<div id="auth">
  <button id="googleBtn">Sign in with Google</button>
</div>

<div id="dashboard" style="display:none;">
  <h2>Create QR</h2>
  <input id="label" placeholder="Label"><br>
  <input id="url" placeholder="https://example.com"><br>
  <button id="createBtn">Create QR</button>

  <h2>Your QR Codes</h2>
  <div id="qrList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const ADMIN_EMAIL = "youremail@gmail.com";

const firebaseConfig = {
  piKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const qrRef = collection(db, "qrcodes");

const baseURL = "https://YOURUSERNAME.github.io/qr-dashboard/scan.html";

googleBtn.onclick = async () => {
  await signInWithPopup(auth, new GoogleAuthProvider());
};

onAuthStateChanged(auth, user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    auth.style.display = "block";
    dashboard.style.display = "none";
    if (user) alert("Access denied");
    return;
  }
  auth.style.display = "none";
  dashboard.style.display = "block";
});

createBtn.onclick = async () => {
  if (!label.value || !url.value) return alert("Missing fields");
  await addDoc(qrRef, { label: label.value, url: url.value, scans: 0, daily:{} });
  label.value = "";
  url.value = "";
};

function downloadQR(canvas, name){
  const a = document.createElement("a");
  a.href = canvas.toDataURL();
  a.download = `${name}.png`;
  a.click();
}

async function remove(id){
  if(confirm("Delete this QR?")){
    await deleteDoc(doc(db,"qrcodes",id));
  }
}

onSnapshot(qrRef, snap => {
  qrList.innerHTML = "";
  snap.forEach(d => {
    const data = d.data();
    const row = document.createElement("div");
    row.className = "qr-item";

    const box = document.createElement("div");
    const qr = new QRCode(box, {
      text: `${baseURL}?id=${d.id}`,
      width:120,
      height:120
    });

    const info = document.createElement("div");
    info.className = "qr-info";
    info.innerHTML = `
      <b>${data.label}</b><br>
      Total scans: ${data.scans}<br>
      <pre>${JSON.stringify(data.daily || {}, null, 2)}</pre>
    `;

    const del = document.createElement("button");
    del.textContent = "Delete";
    del.className = "delete";
    del.onclick = () => remove(d.id);

    const dl = document.createElement("button");
    dl.textContent = "Download";
    dl.className = "download";
    dl.onclick = () => downloadQR(box.querySelector("canvas"), data.label);

    info.appendChild(del);
    info.appendChild(dl);
    row.appendChild(box);
    row.appendChild(info);
    qrList.appendChild(row);
  });
});
</script>
</body>
</html>
