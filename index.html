<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Dashboard</title>
  <style>
    body { font-family: Arial; padding:20px; background:#f5f5f5; }
    input, button { margin:5px 0; padding:10px; font-size:16px; }
    .qrcode { margin:10px 0; display:flex; align-items:center; }
    .qrcode img { margin-right:10px; width:100px; height:100px; }
    .deleteBtn { background:red; color:white; border:none; cursor:pointer; padding:5px 10px; border-radius:4px; }
  </style>
</head>
<body>
<h1>QR Dashboard</h1>
<button id="logoutBtn">Logout</button>

<h2>Create QR Code</h2>
<input type="text" id="label" placeholder="Label">
<input type="text" id="url" placeholder="URL (include https://)">
<button id="createBtn">Create QR</button>

<h2>Existing QR Codes</h2>
<div id="qrList"></div>

<!-- Firebase SDK (ES modules) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”¥ Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const qrList = document.getElementById("qrList");
const labelInput = document.getElementById("label");
const urlInput = document.getElementById("url");
const createBtn = document.getElementById("createBtn");

// Your GitHub Pages scan.html URL
const baseURL = "https://dirtwearcompany-sys.github.io/qr-dashboard/scan.html";

// Only allow logged-in users
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    loadQRCodes();
  }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "login.html";
});

// Create QR code
createBtn.addEventListener("click", async () => {
  const label = labelInput.value.trim();
  const url = urlInput.value.trim();
  if (!label || !url) return alert("Fill both fields");
  if (!url.startsWith("http")) return alert("URL must start with http:// or https://");

  const docRef = await addDoc(collection(db, "qrcodes"), {
    label,
    url,
    scans: 0,
    daily: {}
  });

  appendQR(docRef.id, label, url);

  labelInput.value = "";
  urlInput.value = "";
});

// Load existing QR codes
async function loadQRCodes() {
  qrList.innerHTML = "";
  const querySnap = await getDocs(collection(db, "qrcodes"));
  querySnap.forEach(docSnap => {
    const data = docSnap.data();
    appendQR(docSnap.id, data.label, data.url);
  });
}

// Append a QR code
function appendQR(id, label, url) {
  const qrDiv = document.createElement("div");
  qrDiv.className = "qrcode";

  const qrImg = document.createElement("img");

  // Use the global QRCode library
  QRCode.toDataURL(`${baseURL}?id=${id}`, { width: 100 }, function (err, urlData) {
    if (err) console.error(err);
    qrImg.src = urlData;
  });

  const text = document.createElement("span");
  text.textContent = `${label} â†’ ${url}`;

  const deleteBtn = document.createElement("button");
  deleteBtn.className = "deleteBtn";
  deleteBtn.textContent = "Delete";
  deleteBtn.onclick = async () => {
    await deleteDoc(doc(db, "qrcodes", id));
    qrDiv.remove();
  };

  qrDiv.appendChild(qrImg);
  qrDiv.appendChild(text);
  qrDiv.appendChild(deleteBtn);
  qrList.appendChild(qrDiv);
}
</script>

<!-- QRCode library as global script -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

</body>
</html>
