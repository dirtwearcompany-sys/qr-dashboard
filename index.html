
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QR Scan Dashboard</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    h1 { margin-bottom: 20px; }
    .qr-card { display: inline-block; border: 1px solid #ccc; padding: 10px; margin: 10px; border-radius: 8px; text-align: center; width: 180px; }
    canvas { margin-top: 10px; }
    button { margin-top: 5px; display: block; width: 100%; }
  </style>
</head>
<body>
<h1>QR Scan Dashboard</h1>
<div id="qrContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";

// ðŸ”¥ Replace with your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

onAuthStateChanged(auth, async (user) => {
  if(!user){
    window.location.href = "login.html";
    return;
  }

  const qrContainer = document.getElementById("qrContainer");
  qrContainer.innerHTML = "";

  const snapshot = await getDocs(collection(db, "qr_codes"));

  snapshot.forEach(async (docSnap) => {
    const data = docSnap.data();
    const codeId = docSnap.id;

    // Create card
    const card = document.createElement("div");
    card.className = "qr-card";

    const title = document.createElement("div");
    title.textContent = `${codeId}: ${data.count || 0} scans`;
    card.appendChild(title);

    // QR code canvas
    const qrCanvas = document.createElement("canvas");
    card.appendChild(qrCanvas);
    const scanURL = `${window.location.origin}/scan.html?id=${codeId}`;
    await QRCode.toCanvas(qrCanvas, scanURL, { width: 150 });

    // Download button
    const downloadBtn = document.createElement("button");
    downloadBtn.textContent = "Download QR";
    downloadBtn.onclick = () => {
      const link = document.createElement("a");
      link.href = qrCanvas.toDataURL("image/png");
      link.download = `${codeId}.png`;
      link.click();
    };
    card.appendChild(downloadBtn);

    // Delete button
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete QR";
    deleteBtn.onclick = async () => {
      if(confirm(`Are you sure you want to delete ${codeId}?`)){
        await deleteDoc(doc(db, "qr_codes", codeId));
        card.remove(); // Remove card from dashboard
      }
    };
    card.appendChild(deleteBtn);

    qrContainer.appendChild(card);
  });
});

// Optional: helper to create new QR code
async function createQRCode(codeId){
  const docRef = doc(db, "qr_codes", codeId);
  const docSnap = await getDoc(docRef);
  if(!docSnap.exists()){
    await setDoc(docRef, { count: 0 });
    alert(`QR code ${codeId} created! Refresh page to see it.`);
  }
}
</script>
</body>
</html>
