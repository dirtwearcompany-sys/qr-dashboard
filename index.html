<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR Code generation -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { font-family: Arial,sans-serif; background:#f9f9f9; margin:0; }
header { background:#4CAF50; color:white; padding:15px; display:flex; justify-content:space-between; }
main { max-width:900px; margin:auto; padding:20px; }
input, button { width:100%; padding:10px; margin:5px 0; }
.qr-card { background:white; padding:15px; margin:10px 0; border-radius:6px; }
.qr-actions button { width:auto; margin-right:5px; }
.scan-table { width:100%; border-collapse:collapse; margin-top:10px; }
.scan-table th, .scan-table td { border:1px solid #ccc; padding:5px; text-align:left; }
.scan-table th { background:#f0f0f0; }
.locked { opacity:0.6; }
</style>
</head>
<body>
<header>
  <h2>QR Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <h3>Create QR Code</h3>
  <input id="qrLabel" placeholder="Label (optional)">
  <input id="qrText" placeholder="Full URL (optional, leave blank to generate scan.html)">
  <button onclick="createQRCode()">Create QR</button>

  <h3>Your QR Codes</h3>
  <div id="qrList"></div>
</main>

<script>
// ---------------------- FIREBASE CONFIG ----------------------
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e",
  storageBucket: "qr-tracker-4b53e.appspot.com",
  messagingSenderId: "329754045002",
  appId: "1:329754045002:web:922633ad6ada8018a1d4b3"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let user;

// ---------------------- CONFIG ----------------------
const githubPagesUrl = "https://dirtwearcompany-sys.github.io/qr.dashboard";

// ---------------------- AUTH CHECK ----------------------
auth.onAuthStateChanged(u => {
  if (!u) location.href='login.html';
  user = u;
  loadQRCodesRealtime();
});

// ---------------------- LOGOUT ----------------------
function logout() { auth.signOut().then(()=>location.href='login.html'); }

// ---------------------- CREATE QR CODE ----------------------
function createQRCode() {
  const label = qrLabel.value.trim() || "Untitled QR";
  let text = qrText.value.trim();

  db.collection('qrcodes').add({
    uid: user.uid,
    text: '', // placeholder
    label,
    scans: 0,
    lastScan: null,
    locked: false
  }).then(docRef => {
    // Use user URL if provided; else scan.html link
    if (!text || !/^https?:\/\//.test(text)) {
      text = `${githubPagesUrl}/scan.html?id=${docRef.id}`;
    }
    return docRef.update({ text });
  }).then(() => {
    qrLabel.value = '';
    qrText.value = '';
  }).catch(err => alert(err.message));
}

// ---------------------- LOAD QR CODES & LIVE SCANS ----------------------
function loadQRCodesRealtime() {
  db.collection('qrcodes').where('uid','==',user.uid)
    .onSnapshot(snapshot => {
      qrList.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const div = document.createElement('div');
        div.className = `qr-card${d.locked ? ' locked' : ''}`;
        div.id = `qr-${doc.id}`;
        div.innerHTML = `
          <strong>${d.label}</strong><br>
          Status: <span id="status-${doc.id}">${d.locked ? 'Locked' : 'Unlocked'}</span><br>
          Scans: <span id="scancount-${doc.id}">${d.scans}</span><br>
          Last Scan: <span id="lastscan-${doc.id}">${d.lastScan ? d.lastScan.toDate().toLocaleString() : 'Never'}</span><br><br>
          <canvas id="c-${doc.id}"></canvas><br><br>
          <div class="qr-actions">
            <button onclick="downloadQRCode('${doc.id}')">Download</button>
            <button onclick="deleteQRCode('${doc.id}')">Delete</button>
            <button onclick="toggleLock('${doc.id}')">${d.locked ? 'Unlock' : 'Lock'}</button>
          </div>
          <h4>Scan Log</h4>
          <table class="scan-table" id="table-${doc.id}">
            <thead><tr><th>#</th><th>Date & Time</th></tr></thead>
            <tbody></tbody>
          </table>
        `;
        qrList.appendChild(div);

        // Generate QR code
        QRCode.toCanvas(document.getElementById(`c-${doc.id}`), d.text);

        // ---------------------- LIVE SCAN LOG & COUNT ----------------------
        // Listen to this QR's document to update scans & lastScan
        db.collection('qrcodes').doc(doc.id)
          .onSnapshot(docSnap => {
            const data = docSnap.data();
            document.getElementById(`scancount-${doc.id}`).textContent = data.scans;
            document.getElementById(`lastscan-${doc.id}`).textContent =
              data.lastScan ? data.lastScan.toDate().toLocaleString() : 'Never';
          });

        // Optional: If you have a scans subcollection, listen here for live log
        // Uncomment if you store each scan separately
        /*
        db.collection('qrcodes').doc(doc.id)
          .collection('scans').orderBy('timestamp','desc')
          .onSnapshot(scanSnapshot => {
            const tbody = document.querySelector(`#table-${doc.id} tbody`);
            tbody.innerHTML = '';
            let count = 0;
            scanSnapshot.forEach(snap => {
              count++;
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${count}</td><td>${snap.data().timestamp.toDate().toLocaleString()}</td>`;
              tbody.appendChild(tr);
            });
          });
        */
      });
    });
}

// ---------------------- DOWNLOAD QR ----------------------
function downloadQRCode(id) {
  const canvas = document.getElementById(`c-${id}`);
  const link = document.createElement('a');
  link.href = canvas.toDataURL('image/png');
  link.download = 'qr-code.png';
  link.click();
}

// ---------------------- DELETE QR ----------------------
function deleteQRCode(id) {
  if (confirm("Delete this QR code?")) {
    db.collection('qrcodes').doc(id).delete();
  }
}

// ---------------------- LOCK/UNLOCK ----------------------
function toggleLock(id) {
  const docRef = db.collection('qrcodes').doc(id);
  docRef.get().then(doc => {
    if (!doc.exists) return;
    const current = doc.data().locked || false;
    docRef.update({ locked: !current });
  });
}
</script>
</body>
</html>
