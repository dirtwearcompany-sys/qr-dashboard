<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; }
header { background:#4CAF50; color:white; padding:15px; display:flex; justify-content:space-between; }
main { max-width:800px; margin:auto; padding:20px; }
input, button { width:100%; padding:10px; margin:5px 0; }
.qr-card { background:white; padding:15px; margin:10px 0; border-radius:6px; }
</style>
</head>

<body>
<header>
  <h2>QR Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <h3>Create QR Code</h3>
  <input id="qrLabel" placeholder="Label (optional)">
  <input id="qrText" placeholder="URL or text">
  <button onclick="createQRCode()">Create QR</button>

  <h3>Your QR Codes</h3>
  <div id="qrList"></div>
</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e",
  storageBucket: "qr-tracker-4b53e.appspot.com",
  messagingSenderId: "329754045002",
  appId: "1:329754045002:web:922633ad6ada8018a1d4b3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
let user;

// Auth check
auth.onAuthStateChanged(u => {
  if (!u) location.href = 'login.html';
  user = u;
  loadQRCodesRealtime();
});

// Logout
function logout() {
  auth.signOut().then(() => location.href='login.html');
}

// CREATE QR
function createQRCode() {
  const text = qrText.value.trim();
  const label = qrLabel.value.trim();

  if (!text) return alert("Enter a URL or text");

  db.collection('qrcodes').add({
    uid: user.uid,
    text,
    label,
    scans: 0
  })
  .then(() => {
    console.log("✅ QR CREATED");
    qrText.value = '';
    qrLabel.value = '';
  })
  .catch(err => {
    console.error("❌ Firestore error:", err);
    alert(err.message);
  });
}

// LOAD QRS
function loadQRCodesRealtime() {
  db.collection('qrcodes')
    .where('uid','==',user.uid)
    .onSnapshot(snapshot => {
      qrList.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const div = document.createElement('div');
        div.className = 'qr-card';

        div.innerHTML = `
          <strong>${d.label || 'No label'}</strong><br>
          ${d.text}<br>
          Scans: ${d.scans}<br>
          <canvas id="c-${doc.id}"></canvas>
          <button onclick="deleteQRCode('${doc.id}')">Delete</button>
        `;

        qrList.appendChild(div);

        QRCode.toCanvas(
          document.getElementById(`c-${doc.id}`),
          location.origin + '/scan.html?id=' + doc.id
        );
      });
    });
}

// DELETE
function deleteQRCode(id) {
  db.collection('qrcodes').doc(id).delete();
}
</script>
</body>
</html>
