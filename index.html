
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<h1>QR Code Dashboard</h1>
<button onclick="logout()">Logout</button>

<h3>Create a new QR code</h3>
<input type="text" id="qrText" placeholder="Enter URL or text">
<button onclick="createQRCode()">Create QR Code</button>

<h3>Your QR Codes</h3>
<div id="qrList"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDPfjv3ZZ18ELPiC2Jc-z_yk86ejOvAad4",
  authDomain: "qr-tracker-4b53e.firebaseapp.com",
  projectId: "qr-tracker-4b53e",
  storageBucket: "qr-tracker-4b53e.firebasestorage.app",
  messagingSenderId: "329754045002",
  appId: "1:329754045002:web:922633ad6ada8018a1d4b3"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let user;

auth.onAuthStateChanged(u => {
  if (!u) return location.href = 'login.html';
  user = u;
  loadQRCodes();
});

function logout() {
  auth.signOut().then(() => location.href = 'login.html');
}

function createQRCode() {
  const text = document.getElementById('qrText').value;
  if(!text) return alert("Enter something to generate QR code");
  
  const docRef = db.collection('qrcodes').doc();
  docRef.set({
    uid: user.uid,
    text: text,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    scans: 0
  }).then(() => {
    loadQRCodes();
    document.getElementById('qrText').value = '';
  });
}

function loadQRCodes() {
  db.collection('qrcodes').where('uid','==',user.uid)
    .orderBy('createdAt','desc')
    .get().then(snapshot => {
      const container = document.getElementById('qrList');
      container.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.style.border = "1px solid black";
        div.style.padding = "10px";
        div.style.margin = "10px 0";
        const qrId = doc.id;
        div.innerHTML = `
          <p>Text/URL: ${data.text}</p>
          <p>Scans: ${data.scans}</p>
          <canvas id="canvas-${qrId}"></canvas><br>
          <button onclick="downloadQRCode('${qrId}')">Download</button>
          <button onclick="deleteQRCode('${qrId}')">Delete</button>
        `;
        container.appendChild(div);
        QRCode.toCanvas(document.getElementById(`canvas-${qrId}`), window.location.origin + '/scan.html?id=' + qrId, function (error) {
          if (error) console.error(error);
        });
      });
    });
}

function downloadQRCode(id) {
  const canvas = document.getElementById(`canvas-${id}`);
  const link = document.createElement('a');
  link.href = canvas.toDataURL("image/png");
  link.download = 'qr.png';
  link.click();
}

function deleteQRCode(id) {
  if(confirm("Delete this QR code?")) {
    db.collection('qrcodes').doc(id).delete().then(loadQRCodes);
  }
}
</script>
</body>
</html>
